<?php
defined('PROJECT_PATH') OR exit('No direct script access allowed');

class Email {

    // Check if email notifications are enabled
    private static function is_enabled() {
        return Config::get_safe('notifications_enabled', '0') === '1';
    }

    // Send email notification when new comment is posted
    public static function notify_new_comment($comment_id) {
        // Check if this notification type is enabled
        if (!self::is_enabled() || Config::get_safe('notify_admin_new_comment', '0') !== '1') {
            return false;
        }

        $db = DB::get_instance();

        // Get comment details
        $comment = $db->query("
            SELECT c.*, p.plain_text as post_excerpt, p.title as post_title
            FROM comments c
            LEFT JOIN posts p ON c.post_id = p.id
            WHERE c.id = ?
        ", $comment_id)->first();

        if (!$comment) return false;

        // Get admin email from config
        $admin_email = Config::get_safe('admin_email', null);
        if (!$admin_email) return false;

        $site_name = Config::get_safe('from_name', Config::get('title'));
        $from_email = Config::get_safe('from_email', 'noreply@' . $_SERVER['HTTP_HOST']);
        $site_url = 'http://' . $_SERVER['HTTP_HOST'];

        $subject = "[$site_name] ðŸ’¬ Neuer Kommentar wartet auf Freigabe";

        $message = "Hallo!\n\n";
        $message .= "Ein neuer Kommentar wurde auf deinem Blog gepostet und wartet auf Freigabe.\n\n";
        $message .= "Autor: " . $comment['author_name'] . "\n";
        if ($comment['author_email']) {
            $message .= "E-Mail: " . $comment['author_email'] . "\n";
        }
        $message .= "Beitrag: " . ($comment['post_title'] ?: substr($comment['post_excerpt'], 0, 50) . "...") . "\n\n";
        $message .= "Kommentar:\n" . $comment['content'] . "\n\n";
        $message .= "Freigeben: " . $site_url . "/admin/comments.php?status=pending\n\n";
        $message .= "---\n";
        $message .= $site_name;

        $headers = "From: " . $site_name . " <" . $from_email . ">\r\n";
        $headers .= "Reply-To: " . ($comment['author_email'] ?: $from_email) . "\r\n";
        $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";

        return mail($admin_email, $subject, $message, $headers);
    }

    // Send notification when comment is approved
    public static function notify_comment_approved($comment_id) {
        // Check if this notification type is enabled
        if (!self::is_enabled() || Config::get_safe('notify_user_approved', '0') !== '1') {
            return false;
        }

        $db = DB::get_instance();

        $comment = $db->query("
            SELECT c.*, p.plain_text as post_excerpt, p.title as post_title, p.id as post_id
            FROM comments c
            LEFT JOIN posts p ON c.post_id = p.id
            WHERE c.id = ?
        ", $comment_id)->first();

        if (!$comment || !$comment['author_email']) return false;

        $site_name = Config::get_safe('from_name', Config::get('title'));
        $from_email = Config::get_safe('from_email', 'noreply@' . $_SERVER['HTTP_HOST']);
        $site_url = 'http://' . $_SERVER['HTTP_HOST'];

        $subject = "[$site_name] âœ… Dein Kommentar wurde genehmigt";

        $message = "Hallo " . $comment['author_name'] . "!\n\n";
        $message .= "Dein Kommentar auf \"" . ($comment['post_title'] ?: substr($comment['post_excerpt'], 0, 50) . "...") . "\" wurde genehmigt und ist jetzt sichtbar.\n\n";
        $message .= "Zum Beitrag: " . $site_url . "/?id=" . $comment['post_id'] . "\n\n";
        $message .= "Vielen Dank fÃ¼r deinen Kommentar!\n\n";
        $message .= "---\n";
        $message .= $site_name;

        $headers = "From: " . $site_name . " <" . $from_email . ">\r\n";
        $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";

        return mail($comment['author_email'], $subject, $message, $headers);
    }

    // Send test email
    public static function send_test_email($to_email = null) {
        if (!self::is_enabled()) {
            return ['success' => false, 'message' => 'Email notifications are disabled'];
        }

        $to = $to_email ?: Config::get_safe('admin_email', null);
        if (!$to) {
            return ['success' => false, 'message' => 'No recipient email configured'];
        }

        $site_name = Config::get_safe('from_name', Config::get('title'));
        $from_email = Config::get_safe('from_email', 'noreply@' . $_SERVER['HTTP_HOST']);

        $subject = "[$site_name] âœ… Test Email";
        $message = "Dies ist eine Test-Email vom Blog-System.\n\n";
        $message .= "Wenn du diese Email siehst, funktioniert das Email-System! ðŸŽ‰\n\n";
        $message .= "Zeit: " . date('d.m.Y H:i:s') . "\n";
        $message .= "---\n";
        $message .= $site_name;

        $headers = "From: " . $site_name . " <" . $from_email . ">\r\n";
        $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";

        $result = mail($to, $subject, $message, $headers);

        return [
            'success' => $result,
            'message' => $result ? 'Test email sent successfully!' : 'Failed to send test email'
        ];
    }
}
