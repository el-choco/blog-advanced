<?php
require_once 'common.php';

// Handle actions
$message = '';
$message_type = '';

if($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    $action = $_POST['action'];

    // Single Quick Action
    if(isset($_POST['post_id']) && isset($_POST['quick_action'])) {
        $post_id = $_POST['post_id'];
        $quick_action = $_POST['quick_action'];
        
        $db = DB::get_instance();
        
        switch($quick_action) {
            case 'toggle_sticky':
                // Get current status
                $current = $db->query("SELECT is_sticky FROM posts WHERE id = ?", [$post_id])->first();
                
                if ($current) {
                    $new_sticky = $current['is_sticky'] ? 0 : 1;
                    $db->query("UPDATE posts SET is_sticky = ? WHERE id = ?", [$new_sticky, $post_id]);
                    $message = $new_sticky ? 'Beitrag als Sticky markiert' : 'Sticky entfernt';
                    $message_type = 'success';
                }
                break;

            case 'toggle_hidden':
                // Get current status
                $current = $db->query("SELECT status FROM posts WHERE id = ?", [$post_id])->first();
                
                if ($current) {
                    $new_status = ($current['status'] == 4) ? 1 : 4;
                    $db->query("UPDATE posts SET status = ? WHERE id = ?", [$new_status, $post_id]);
                    $message = ($new_status == 4) ? 'Beitrag versteckt' : 'Beitrag sichtbar';
                    $message_type = 'success';
                }
                break;
                
            case 'delete':
                $db->query("UPDATE posts SET status = ? WHERE id = ?", [5, $post_id]);
                $message = 'Beitrag in den Papierkorb verschoben';
                $message_type = 'success';
                break;
        }
    }
}

// Get filter and sort parameters
$filter = $_GET['filter'] ?? 'all';
$sort = $_GET['sort'] ?? 'newest';
$search = $_GET['search'] ?? '';

// Get statistics
$stats = AdminHelper::getPostStats();

// Get filtered posts
$posts = AdminHelper::getAllPosts(false, $filter, $sort, $search);

// Get trash count
$trash_count = AdminHelper::getTrashCount();

function escape($str) {
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}
?><!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Beitr√§ge - <?php echo escape(Config::get("title")); ?></title>
    <meta name="robots" content="noindex, nofollow">
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    
    <link href="../static/styles/main.css" rel="stylesheet" type="text/css" />
    <link href="../static/styles/<?php echo rawurlencode(Config::get_safe("theme", "theme01")); ?>.css" rel="stylesheet" type="text/css" />
    <link href="../static/styles/custom1.css" rel="stylesheet" type="text/css" />
    <link href="../static/styles/admin.css" rel="stylesheet" type="text/css" />
    
    <link href="https://fonts.googleapis.com/css?family=Open+Sans&amp;subset=all" rel="stylesheet">
    
    <style>
    /* Bulk Actions komplett versteckt */
    .bulk-actions-bar,
    .bulk-select,
    .post-checkbox,
    #select-all,
    #selectAll,
    .checkbox-cell,
    #bulkBar,
    #bulkForm {
        display: none !important;
    }
    
    .message {
        padding: 12px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
    }
    
    .message-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #2c5aa0;
    }
    
    .stat-label {
        color: #666;
        margin-top: 8px;
    }
    
    .filters-bar {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .filter-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .search-box {
        flex: 1;
        min-width: 200px;
    }
    
    .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-sticky {
        background: #ffc107;
        color: #000;
    }
    
    .badge-hidden {
        background: #6c757d;
        color: white;
    }
    
    .badge-info {
        background: #17a2b8;
        color: white;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .quick-action-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .quick-action-btn:hover {
        background: #f0f2f5;
    }
    
    .post-text-preview {
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    </style>
</head>
<body class="admin-body">
    
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="admin-container">
            <h1>üìù Beitr√§ge verwalten</h1>
            <div class="admin-user">
                <span>üë§ <?php echo escape(Config::get("name")); ?></span>
                <a href="../" class="btn btn-sm">‚Üê Zur√ºck zum Blog</a>
            </div>
        </div>
    </div>
    
    <div class="admin-layout">
        
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
            <nav class="admin-nav">
                <a href="index.php">üìä Dashboard</a>
                <a href="posts.php" class="active">üìù Beitr√§ge</a>
                <a href="comments.php">üí¨ Kommentare</a>
                <a href="media.php">üìÅ Dateien</a>
                <a href="trash.php">üóëÔ∏è Papierkorb <?php if($trash_count > 0): ?><span class="badge"><?php echo $trash_count; ?></span><?php endif; ?></a>
                <a href="settings.php">‚öôÔ∏è Einstellungen</a>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="admin-content">
            
            <?php if($message): ?>
            <div class="message message-<?php echo $message_type; ?>">
                <?php echo escape($message); ?>
            </div>
            <?php endif; ?>
            
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value"><?php echo $stats['total']; ?></div>
                    <div class="stat-label">Gesamt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><?php echo $stats['published']; ?></div>
                    <div class="stat-label">Ver√∂ffentlicht</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><?php echo $stats['hidden']; ?></div>
                    <div class="stat-label">Versteckt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><?php echo $stats['sticky']; ?></div>
                    <div class="stat-label">Sticky</div>
                </div>
            </div>
            
            <!-- Filters -->
            <form method="GET" class="filters-bar">
                <select name="filter" class="filter-select" onchange="this.form.submit()">
                    <option value="all" <?php echo $filter === 'all' ? 'selected' : ''; ?>>Alle Beitr√§ge</option>
                    <option value="published" <?php echo $filter === 'published' ? 'selected' : ''; ?>>Ver√∂ffentlicht</option>
                    <option value="hidden" <?php echo $filter === 'hidden' ? 'selected' : ''; ?>>Versteckt</option>
                    <option value="sticky" <?php echo $filter === 'sticky' ? 'selected' : ''; ?>>Sticky</option>
                </select>
                
                <select name="sort" class="filter-select" onchange="this.form.submit()">
                    <option value="newest" <?php echo $sort === 'newest' ? 'selected' : ''; ?>>Neueste zuerst</option>
                    <option value="oldest" <?php echo $sort === 'oldest' ? 'selected' : ''; ?>>√Ñlteste zuerst</option>
                </select>
                
                <div class="search-box">
                    <input type="text" name="search" class="search-input" placeholder="Beitr√§ge durchsuchen..." value="<?php echo escape($search); ?>">
                </div>
                
                <button type="submit" class="btn btn-primary">Suchen</button>
            </form>
            
            <!-- Posts Table -->
            <div class="admin-panel">
                <div class="panel-header">
                    <h2>üìù <?php echo count($posts); ?> Beitr√§ge</h2>
                </div>
                <div class="panel-body" style="padding: 0;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Inhalt</th>
                                <th>Datum</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if(empty($posts)): ?>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                                        Keine Beitr√§ge gefunden
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php foreach($posts as $post): ?>
                                    <tr>
                                        <td><code>#<?php echo escape($post['id']); ?></code></td>
                                        <td>
                                            <div class="post-text-preview">
                                                <?php echo escape(AdminHelper::getExcerpt($post['text'], 100)); ?>
                                            </div>
                                            <?php if($post['has_images']): ?>
                                                <span class="badge badge-info">üñºÔ∏è <?php echo $post['image_count']; ?></span>
                                            <?php endif; ?>
                                        </td>
                                        <td><?php echo AdminHelper::formatDate($post['time']); ?></td>
                                        <td>
                                            <?php if($post['sticky']): ?>
                                                <span class="badge badge-sticky">üìå Sticky</span>
                                            <?php endif; ?>
                                            <?php if($post['hidden']): ?>
                                                <span class="badge badge-hidden">üëÅÔ∏è Versteckt</span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <form method="POST" style="display: inline;">
                                                    <input type="hidden" name="action" value="">
                                                    <input type="hidden" name="post_id" value="<?php echo escape($post['id']); ?>">
                                                    <input type="hidden" name="quick_action" value="toggle_sticky">
                                                    <button type="submit" class="quick-action-btn" title="<?php echo $post['sticky'] ? 'Sticky entfernen' : 'Als Sticky markieren'; ?>">
                                                        üìå
                                                    </button>
                                                </form>
                                                
                                                <form method="POST" style="display: inline;">
                                                    <input type="hidden" name="action" value="">
                                                    <input type="hidden" name="post_id" value="<?php echo escape($post['id']); ?>">
                                                    <input type="hidden" name="quick_action" value="toggle_hidden">
                                                    <button type="submit" class="quick-action-btn" title="<?php echo ($post['hidden']) ? 'Sichtbar machen' : 'Verstecken'; ?>">
                                                        üëÅÔ∏è
                                                    </button>
                                                </form>
                                                
                                                <a href="../#id=<?php echo $post['id']; ?>" class="quick-action-btn" title="Bearbeiten">‚úèÔ∏è</a>
                                                
                                                <form method="POST" style="display: inline;" onsubmit="return confirm('Beitrag in den Papierkorb verschieben?');">
                                                    <input type="hidden" name="action" value="">
                                                    <input type="hidden" name="post_id" value="<?php echo escape($post['id']); ?>">
                                                    <input type="hidden" name="quick_action" value="delete">
                                                    <button type="submit" class="quick-action-btn" title="In Papierkorb" style="color: #dc3545;">üóëÔ∏è</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </main>
        
    </div>
    
</body>
</html>
