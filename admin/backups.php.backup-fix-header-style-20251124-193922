<?php
require_once 'common.php';

$page_title = 'Backup-Verwaltung';
$error = null;
$success = null;

// Load Backup class
require_once PROJECT_PATH . 'app/backup.class.php';

// Handle POST actions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        $action = $_POST['action'] ?? '';
        
        switch ($action) {
            case 'create':
                $backup = Backup::create();
                $success = 'Backup erfolgreich erstellt: ' . $backup['filename'];
                break;
                
            case 'restore':
                $filename = $_POST['file'] ?? '';
                if (empty($filename)) {
                    throw new Exception('Keine Backup-Datei angegeben');
                }
                Backup::restore($filename);
                $success = 'Backup erfolgreich wiederhergestellt';
                break;
                
            case 'delete':
                $filename = $_POST['file'] ?? '';
                if (empty($filename)) {
                    throw new Exception('Keine Backup-Datei angegeben');
                }
                Backup::delete($filename);
                $success = 'Backup erfolgreich gelÃ¶scht';
                break;
        }
    } catch (Exception $e) {
        $error = $e->getMessage();
    }
}

// Get list of backups
try {
    $backups = Backup::get_list();
    $total_size = array_sum(array_column($backups, 'size'));
    $last_backup = !empty($backups) ? $backups[0]['created'] : null;
} catch (Exception $e) {
    $error = $e->getMessage();
    $backups = [];
    $total_size = 0;
    $last_backup = null;
}

// Helper function to format file size
function format_bytes($bytes) {
    $units = ['B', 'KB', 'MB', 'GB'];
    $i = 0;
    while ($bytes >= 1024 && $i < count($units) - 1) {
        $bytes /= 1024;
        $i++;
    }
    return round($bytes, 2) . ' ' . $units[$i];
}

function escape($str) {
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}
?><!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ğŸ’¾ Backups - <?php echo escape(Config::get("title")); ?></title>
    <meta name="robots" content="noindex, nofollow">
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <!-- Main Blog Styles -->
    <link href="../static/styles/main.css" rel="stylesheet" type="text/css" />
    <link href="../static/styles/<?php echo rawurlencode(Config::get_safe("theme", "theme01")); ?>.css" rel="stylesheet" type="text/css" />
    <link href="../static/styles/custom1.css" rel="stylesheet" type="text/css" />

    <!-- Admin Styles -->
    <link href="../static/styles/admin.css" rel="stylesheet" type="text/css" />

    <link href="https://fonts.googleapis.com/css?family=Open+Sans&amp;subset=all" rel="stylesheet">
</head>
<body class="admin-body">

    <!-- Admin Header -->
    <header class="admin-header">
        <div class="header-content">
            <h1>ğŸ’¾ Backup-Verwaltung</h1>
            <div class="header-actions">
                <a href="../" class="btn btn-secondary">â† Zum Blog</a>
                <a href="logout.php" class="btn btn-danger">Abmelden</a>
            </div>
        </div>
    </header>

    <div class="admin-layout">

        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
            <nav class="admin-nav">
                <a href="index.php">ğŸ“Š Dashboard</a>
                <a href="posts.php">ğŸ“ BeitrÃ¤ge</a>
                <a href="comments.php">ğŸ’¬ Kommentare</a>
                <a href="media.php">ğŸ“ Dateien</a>
                <a href="backups.php" class="active">ğŸ’¾ Backups</a>
                <a href="trash.php">ğŸ—‘ï¸ Papierkorb</a>
                <a href="settings.php">âš™ï¸ Einstellungen</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">

            <?php if($error): ?>
                <div class="alert alert-danger">
                    âŒ Fehler: <?php echo escape($error); ?>
                </div>
            <?php endif; ?>
            
            <?php if($success): ?>
                <div class="alert alert-success">
                    âœ… <?php echo escape($success); ?>
                </div>
            <?php endif; ?>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“¦</div>
                    <div class="stat-info">
                        <div class="stat-value"><?php echo count($backups); ?></div>
                        <div class="stat-label">VerfÃ¼gbare Backups</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ğŸ’¾</div>
                    <div class="stat-info">
                        <div class="stat-value"><?php echo format_bytes($total_size); ?></div>
                        <div class="stat-label">GesamtgrÃ¶ÃŸe</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-info">
                        <div class="stat-value"><?php echo $last_backup ? date('d.m.Y', $last_backup) : '-'; ?></div>
                        <div class="stat-label">Letztes Backup</div>
                    </div>
                </div>
            </div>

            <!-- Create Backup -->
            <div class="admin-panel">
                <div class="panel-header">
                    <h2>Neues Backup erstellen</h2>
                </div>
                <div class="panel-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="create">
                        <button type="submit" class="btn btn-primary" style="font-size: 16px;">
                            â• Neues Backup erstellen
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Erstellt ein vollstÃ¤ndiges Backup der Datenbank als SQL-Datei.
                        </p>
                    </form>
                </div>
            </div>

            <!-- Backup List -->
            <div class="admin-panel">
                <div class="panel-header">
                    <h2>VerfÃ¼gbare Backups</h2>
                </div>
                <div class="panel-body">
                    <?php if(empty($backups)): ?>
                        <div class="empty-state">
                            <div style="font-size: 64px; opacity: 0.3; margin-bottom: 20px;">ğŸ“¦</div>
                            <h3>Noch keine Backups vorhanden</h3>
                            <p style="color: #666;">Klicke auf "Neues Backup erstellen" um das erste Backup zu erstellen.</p>
                        </div>
                    <?php else: ?>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Dateiname</th>
                                    <th>Erstellt</th>
                                    <th>GrÃ¶ÃŸe</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach($backups as $backup): ?>
                                    <tr>
                                        <td>
                                            <strong>ğŸ“ <?php echo escape($backup['filename']); ?></strong>
                                        </td>
                                        <td>
                                            <?php echo date('d.m.Y H:i:s', $backup['created']); ?>
                                        </td>
                                        <td>
                                            <?php echo format_bytes($backup['size']); ?>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <form method="POST" style="display: inline;">
                                                    <input type="hidden" name="action" value="restore">
                                                    <input type="hidden" name="file" value="<?php echo escape($backup['filename']); ?>">
                                                    <button type="submit" class="btn btn-sm btn-secondary" 
                                                            onclick="return confirm('Backup wirklich wiederherstellen?\n\nâš ï¸ ACHTUNG: Dies Ã¼berschreibt die aktuelle Datenbank!');"
                                                            title="Wiederherstellen">
                                                        ğŸ”„
                                                    </button>
                                                </form>
                                                
                                                <form method="POST" style="display: inline;">
                                                    <input type="hidden" name="action" value="delete">
                                                    <input type="hidden" name="file" value="<?php echo escape($backup['filename']); ?>">
                                                    <button type="submit" class="btn btn-sm btn-danger" 
                                                            onclick="return confirm('Backup wirklich lÃ¶schen?');"
                                                            title="LÃ¶schen">
                                                        ğŸ—‘ï¸
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    <?php endif; ?>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="admin-panel">
                <div class="panel-header">
                    <h2>Schnellzugriff</h2>
                </div>
                <div class="panel-body">
                    <div class="quick-actions">
                        <a href="../#new-post" class="quick-action-card">
                            <div class="qa-icon">âœï¸</div>
                            <div class="qa-label">Neuer Beitrag</div>
                        </a>
                        <a href="backups.php" class="quick-action-card">
                            <div class="qa-icon">ğŸ’¾</div>
                            <div class="qa-label">Backups</div>
                        </a>
                        <a href="comments.php" class="quick-action-card">
                            <div class="qa-icon">ğŸ’¬</div>
                            <div class="qa-label">Kommentare</div>
                        </a>
                        <a href="posts.php" class="quick-action-card">
                            <div class="qa-icon">ğŸ“</div>
                            <div class="qa-label">BeitrÃ¤ge verwalten</div>
                        </a>
                        <a href="media.php" class="quick-action-card">
                            <div class="qa-icon">ğŸ“</div>
                            <div class="qa-label">Dateien</div>
                        </a>
                        <a href="trash.php" class="quick-action-card">
                            <div class="qa-icon">ğŸ—‘ï¸</div>
                            <div class="qa-label">Papierkorb</div>
                        </a>
                    </div>
                </div>
            </div>

        </main>

    </div>

</body>
</html>
